#!/bin/bash

set -e

COMMIT_HASH="21c33302dcfde403532263d6d7659ad9d403c4b4"
BUNDLE_PATH="/tmp/inserted_commit.bundle"

echo "Writing bundle to $BUNDLE_PATH..."

# base64 encoded bundle with software commit
cat << 'EOF_BUNDLE' | base64 -d > "$BUNDLE_PATH"
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
EOF_BUNDLE

git checkout -b "$COMMIT_HASH"_gac

echo "Fetching commit from bundle..."
git fetch "$BUNDLE_PATH"

echo "Cherry-picking commit $COMMIT_HASH into current branch..."
git cherry-pick "$COMMIT_HASH" || {
  echo "Cherry-pick failed. You may need to resolve conflicts manually."
  exit 1
}

echo "Commit inserted successfully."

# replace the root_commit_reference
sed -i 's|^root_commit_reference = "".*|root_commit_reference = "'"$COMMIT_HASH"'"|' ./pre-receive.py

sed -i 's|^root_commit_reference = "".*|root_commit_reference = "'"$COMMIT_HASH"'"|' ./gac.py

chmod +x ./pre-receive.py
chmod +x ./gac.py
chmod +x ./git-push-pull.sh
chmod +x ./git-pull.sh

./gac.py create_server "$1"

echo "Done."